name: Deterministic-Safe CI/CD Pipeline

# =============================================================================
# IntentusNet v2.0 Deterministic-Safe CI/CD Pipeline
#
# This is NOT normal CI/CD.
# Every gate enforces execution truth before deployment.
#
# 9 GATES — all must pass:
#   1. Build Reproducibility Gate       — identical artifact hashes
#   2. Deterministic Execution Gate     — fingerprint stability across runs
#   3. WAL Replay Final-State Gate      — replay state matches live state
#   4. Entropy Detection Gate           — detect random/time/async nondeterminism
#   5. Container Reproducibility Gate   — pinned bases, digest comparison
#   6. Routing Determinism Gate         — same intent → same agent selection
#   7. Crash-Recovery Verification Gate — WAL resume matches clean execution
#   8. WAL Integrity & Tamper Gate      — hash chain + signature verification
#   9. Runtime Snapshot Verification    — snapshot → rebuild → hash match
# =============================================================================

on:
  push:
    branches: [main, develop]
    paths:
      - 'deterministic_agent/**'
      - 'src/intentusnet/**'
      - 'examples/superdemo/**'
  pull_request:
    branches: [main]
    paths:
      - 'deterministic_agent/**'
      - 'src/intentusnet/**'
      - 'examples/superdemo/**'
  workflow_dispatch:
    inputs:
      num_runs:
        description: 'Number of evaluation runs per gate'
        required: false
        default: '3'
      threshold:
        description: 'Reliability threshold (0.0-1.0)'
        required: false
        default: '0.98'

env:
  PYTHON_VERSION: '3.11'
  RELIABILITY_THRESHOLD: '0.98'
  NUM_RUNS: '3'

# =============================================================================
# GATE 1: Build Reproducibility
# =============================================================================
jobs:
  gate-1-build-reproducibility:
    name: "Gate 1: Build Reproducibility"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Build artifact — pass 1
        run: |
          python -m pip install --upgrade pip
          pip install build
          python -m build --sdist --outdir dist1/

      - name: Build artifact — pass 2
        run: |
          python -m build --sdist --outdir dist2/

      - name: Compare artifact content hashes
        run: |
          # Extract both builds and compare file-level content hashes.
          # This verifies true content reproducibility: every file in
          # the sdist must be byte-identical across builds.
          # Raw tarball hashes may differ due to gzip/tar header
          # timestamps (packaging metadata), so we compare content.
          mkdir -p /tmp/norm1 /tmp/norm2
          tar xzf dist1/*.tar.gz -C /tmp/norm1
          tar xzf dist2/*.tar.gz -C /tmp/norm2

          HASH1=$(cd /tmp/norm1 && find . -type f | LC_ALL=C sort | xargs sha256sum | sha256sum | awk '{print $1}')
          HASH2=$(cd /tmp/norm2 && find . -type f | LC_ALL=C sort | xargs sha256sum | sha256sum | awk '{print $1}')

          echo "Build 1 content hash: $HASH1"
          echo "Build 2 content hash: $HASH2"

          if [ "$HASH1" != "$HASH2" ]; then
            echo "::error::GATE 1 FAIL: Build artifact content hash mismatch"
            echo "Build is NOT reproducible — nondeterminism in source files"
            diff -rq /tmp/norm1 /tmp/norm2 || true
            exit 1
          fi

          echo "GATE 1 PASS: Artifact content identical across builds"
          echo "hash=$HASH1" >> $GITHUB_OUTPUT

  # =============================================================================
  # GATE 2: Deterministic Execution (fingerprint stability)
  # =============================================================================
  gate-2-deterministic-execution:
    name: "Gate 2: Deterministic Execution"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: Run deterministic evaluation (3x)
        id: eval
        run: |
          cd deterministic_agent
          python -m eval_agent \
            --dataset tests/golden_dataset.jsonl \
            --wal-dir /tmp/eval_wal \
            --runs ${{ github.event.inputs.num_runs || env.NUM_RUNS }} \
            --threshold ${{ github.event.inputs.threshold || env.RELIABILITY_THRESHOLD }} \
            --output /tmp/evaluation_report.json \
            --verbose
        continue-on-error: true

      - name: Enforce deterministic thresholds
        run: |
          python tests/ci/gate_deterministic_execution.py \
            --report /tmp/evaluation_report.json \
            --threshold ${{ github.event.inputs.threshold || env.RELIABILITY_THRESHOLD }}

      - name: Upload evaluation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gate-2-evaluation-report
          path: /tmp/evaluation_report.json
          retention-days: 30

  # =============================================================================
  # GATE 3: WAL Replay Final-State Match
  # =============================================================================
  gate-3-wal-replay-state:
    name: "Gate 3: WAL Replay Final-State"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest

      - name: WAL replay state verification
        run: |
          python tests/ci/gate_wal_replay_state.py

  # =============================================================================
  # GATE 4: Entropy Detection (nondeterminism scanner)
  # =============================================================================
  gate-4-entropy-detection:
    name: "Gate 4: Entropy Detection"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Scan for nondeterminism sources
        run: |
          python tests/ci/gate_entropy_detection.py

  # =============================================================================
  # GATE 5: Container Reproducibility
  # =============================================================================
  gate-5-container-reproducibility:
    name: "Gate 5: Container Reproducibility"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify Dockerfile uses pinned base image
        run: |
          if [ -f Dockerfile ]; then
            # Check for :latest or unpinned tags
            if grep -qE '^FROM\s+\S+:latest' Dockerfile; then
              echo "::error::GATE 5 FAIL: Dockerfile uses :latest tag"
              echo "Pin the base image to a specific digest: FROM image@sha256:..."
              exit 1
            fi
            echo "GATE 5 PASS: Base image is pinned"
          else
            echo "GATE 5 SKIP: No Dockerfile found (acceptable for library)"
          fi

      - name: Verify pip dependencies are pinned
        run: |
          python -c "
          import sys
          from pathlib import Path

          # Check setup.cfg or pyproject.toml for unpinned deps
          pyproject = Path('pyproject.toml')
          if pyproject.exists():
              content = pyproject.read_text()
              # Warn about unpinned deps but don't fail (library pattern)
              if '>=' in content and '==' not in content:
                  print('INFO: Some dependencies use >= (acceptable for library)')
              print('GATE 5 PASS: Dependency pinning acceptable')
          "

  # =============================================================================
  # GATE 6: Routing Determinism
  # =============================================================================
  gate-6-routing-determinism:
    name: "Gate 6: Routing Determinism"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Routing determinism verification
        run: |
          python tests/ci/gate_routing_determinism.py

  # =============================================================================
  # GATE 7: Crash-Recovery Verification
  # =============================================================================
  gate-7-crash-recovery:
    name: "Gate 7: Crash-Recovery Verification"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Crash-recovery verification
        run: |
          python tests/ci/gate_crash_recovery.py

  # =============================================================================
  # GATE 8: WAL Integrity & Tamper Detection
  # =============================================================================
  gate-8-wal-integrity:
    name: "Gate 8: WAL Integrity & Tamper"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: WAL integrity and tamper verification
        run: |
          python tests/ci/gate_wal_integrity.py

  # =============================================================================
  # GATE 9: Runtime Snapshot Verification
  # =============================================================================
  gate-9-runtime-snapshot:
    name: "Gate 9: Runtime Snapshot Verification"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Runtime snapshot verification
        run: |
          python tests/ci/gate_runtime_snapshot.py

  # =============================================================================
  # UNIT TESTS (parallel with gates)
  # =============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/ -v \
            --ignore=tests/test_failures.py \
            --cov=src/intentusnet \
            --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # =============================================================================
  # FINAL GATE: All gates must pass
  # =============================================================================
  deterministic-safe-deploy:
    name: "Deterministic-Safe Deploy Gate"
    needs:
      - gate-1-build-reproducibility
      - gate-2-deterministic-execution
      - gate-3-wal-replay-state
      - gate-4-entropy-detection
      - gate-5-container-reproducibility
      - gate-6-routing-determinism
      - gate-7-crash-recovery
      - gate-8-wal-integrity
      - gate-9-runtime-snapshot
      - unit-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check all gates
        run: |
          echo "============================================"
          echo "  DETERMINISTIC-SAFE DEPLOYMENT GATE"
          echo "============================================"
          echo ""

          FAILED=0

          check_gate() {
            local gate_name="$1"
            local gate_result="$2"
            if [ "$gate_result" != "success" ]; then
              echo "  FAIL  $gate_name ($gate_result)"
              FAILED=1
            else
              echo "  PASS  $gate_name"
            fi
          }

          check_gate "Gate 1: Build Reproducibility"    "${{ needs.gate-1-build-reproducibility.result }}"
          check_gate "Gate 2: Deterministic Execution"   "${{ needs.gate-2-deterministic-execution.result }}"
          check_gate "Gate 3: WAL Replay Final-State"    "${{ needs.gate-3-wal-replay-state.result }}"
          check_gate "Gate 4: Entropy Detection"         "${{ needs.gate-4-entropy-detection.result }}"
          check_gate "Gate 5: Container Reproducibility" "${{ needs.gate-5-container-reproducibility.result }}"
          check_gate "Gate 6: Routing Determinism"       "${{ needs.gate-6-routing-determinism.result }}"
          check_gate "Gate 7: Crash-Recovery"            "${{ needs.gate-7-crash-recovery.result }}"
          check_gate "Gate 8: WAL Integrity & Tamper"    "${{ needs.gate-8-wal-integrity.result }}"
          check_gate "Gate 9: Runtime Snapshot"          "${{ needs.gate-9-runtime-snapshot.result }}"
          check_gate "Unit Tests"                        "${{ needs.unit-tests.result }}"

          echo ""

          if [ $FAILED -eq 1 ]; then
            echo "DEPLOYMENT BLOCKED — deterministic safety not proven"
            exit 1
          else
            echo "ALL GATES PASSED — deterministic execution verified"
            echo "Safe to deploy."
          fi

      - name: Generate summary
        if: always()
        run: |
          echo "## Deterministic-Safe CI/CD Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1. Build Reproducibility | ${{ needs.gate-1-build-reproducibility.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 2. Deterministic Execution | ${{ needs.gate-2-deterministic-execution.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 3. WAL Replay Final-State | ${{ needs.gate-3-wal-replay-state.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4. Entropy Detection | ${{ needs.gate-4-entropy-detection.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5. Container Reproducibility | ${{ needs.gate-5-container-reproducibility.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 6. Routing Determinism | ${{ needs.gate-6-routing-determinism.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 7. Crash-Recovery | ${{ needs.gate-7-crash-recovery.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 8. WAL Integrity & Tamper | ${{ needs.gate-8-wal-integrity.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 9. Runtime Snapshot | ${{ needs.gate-9-runtime-snapshot.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && 'PASS' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
